{% extends "base.html" %}

{% block title %}My Job Feed{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="header-container d-flex justify-content-between align-items-center mb-3">
        <h1>My Job Feed</h1>
        <span id="job-count" class="badge bg-secondary fs-5"></span>
    </div>

    <div class="controls-container card mb-4">
        <div class="card-header">
            Scrape Controls
        </div>
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-6 col-lg-3">
                    <label for="source-select" class="form-label">Source:</label>
                    <select id="source-select" class="form-select" onchange="updateTimeUnitOptions()">
                        <option value="all" selected>All Sources</option>
                        <option value="linkedin">LinkedIn Only</option>
                        <option value="indeed">Indeed Only</option>
                    </select>
                </div>
                <div class="col-md-6 col-lg-3">
                    <label for="time-value" class="form-label">Time Period:</label>
                    <div class="input-group">
                        <input type="number" id="time-value" value="7" min="1" class="form-control" />
                        <select id="time-unit" class="form-select"></select>
                    </div>
                </div>
                <div class="col-md-6 col-lg-3">
                    <label for="scrape-location" class="form-label">Location:</label>
                    <input type="text" id="scrape-location" class="form-control" placeholder="e.g., New York, NY" />
                </div>
                <div class="col-md-6 col-lg-3">
                    <label for="scrape-keywords" class="form-label">Keywords:</label>
                    <input type="text" id="scrape-keywords" class="form-control" placeholder="e.g., Python Developer" />
                </div>
            </div>
            <div class="row g-3 mt-3">
                <div class="col-12">
                    <label class="form-label">Scrape Mode:</label>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" id="mode-add" name="scrape-mode" value="add" checked />
                        <label class="form-check-label" for="mode-add">Add to Inbox</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" id="mode-archive" name="scrape-mode" value="archive" />
                        <label class="form-check-label" for="mode-archive">Archive Inbox & Add</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" id="mode-delete" name="scrape-mode" value="delete" />
                        <label class="form-check-label" for="mode-delete">Clear Inbox & Add</label>
                    </div>
                </div>
            </div>
            <div class="scrape-action-bar text-center mt-3">
                <button id="scrape-button" class="btn btn-primary" onclick="startScrape()">Scrape New Jobs</button>
                <span id="scrape-status" class="ms-3">Status: Idle</span>
            </div>
        </div>
    </div>
    
    <ul class="nav nav-tabs mb-3" id="main-tabs" role="tablist">
        <li class="nav-item" role="presentation"><button class="nav-link active" id="inbox-tab" data-bs-toggle="tab" data-bs-target="#jobs-pane" type="button" role="tab" data-status="inbox">Inbox</button></li>
        <li class="nav-item" role="presentation"><button class="nav-link" id="want-to-apply-tab" data-bs-toggle="tab" data-bs-target="#jobs-pane" type="button" role="tab" data-status="want_to_apply">Want to Apply</button></li>
        <li class="nav-item" role="presentation"><button class="nav-link" id="applied-tab" data-bs-toggle="tab" data-bs-target="#jobs-pane" type="button" role="tab" data-status="applied">Applied</button></li>
        <li class="nav-item" role="presentation"><button class="nav-link" id="archived-tab" data-bs-toggle="tab" data-bs-target="#jobs-pane" type="button" role="tab" data-status="archived">Archived</button></li>
        <li class="nav-item" role="presentation"><button class="nav-link" id="resume-creator-tab" data-bs-toggle="tab" data-bs-target="#resume-creator-pane" type="button" role="tab">Create Resume/CV</button></li>
    </ul>

    <div class="tab-content" id="main-tab-content">
        <div class="tab-pane fade show active" id="jobs-pane" role="tabpanel">
            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Source</th>
                            <th>Date Posted</th>
                            <th>Title & Company</th>
                            <th>Experience Snippet</th>
                            <th>Location</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="jobs-tbody"></tbody>
                </table>
            </div>
            <div id="loading-spinner" class="spinner-border text-primary" role="status" style="display: none;">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
        
        <div class="tab-pane fade" id="resume-creator-pane" role="tabpanel">
            <div class="card">
                <div class="card-body">
                    <h2 class="card-title">Create Resume and Cover Letter</h2>
                    <input type="hidden" id="resume-job-id" value="">
                    <div class="mb-2"><small>Job to tailor for: <span id="resume-job-title-display" class="fw-bold">None selected. Select a job and click 'Generate'.</span></small></div>
                    <textarea id="job-description-input" class="form-control mb-3" placeholder="Job description will be auto-filled here." rows="8"></textarea>
                    <button id="generate-resume-cv-button" class="btn btn-success">Generate Documents</button>
                    <div id="resume-creator-status" class="mt-3"></div>
                    <div id="pdf-preview-area" class="mt-3" style="display: none;">
                        <div class="row" style="height: 600px;">
                            <div class="col-md-6 h-100"><iframe id="resume-preview-iframe" class="w-100 h-100 border"></iframe></div>
                            <div class="col-md-6 h-100"><iframe id="cv-preview-iframe" class="w-100 h-100 border"></iframe></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let currentJobStatus = 'inbox';
    let statusInterval;
    const timeUnitSelect = document.getElementById('time-unit');
    const timeOptions = {
        full: `<option value="seconds">Seconds</option><option value="minutes">Minutes</option><option value="hours">Hours</option><option value="days" selected>Days</option><option value="weeks">Weeks</option><option value="months">Months</option>`,
        indeed: `<option value="days" selected>Days</option><option value="weeks">Weeks</option><option value="months">Months</option>`
    };

    function updateTimeUnitOptions() {
        const source = document.getElementById('source-select').value;
        timeUnitSelect.innerHTML = (source === 'indeed') ? timeOptions.indeed : timeOptions.full;
    }

    function openResumeCreatorTab(jobId, jobTitle, jobDescription) {
        document.getElementById('resume-job-id').value = jobId;
        document.getElementById('job-description-input').value = jobDescription;
        document.getElementById('resume-job-title-display').textContent = jobTitle || `Job ID: ${jobId}`;
        document.getElementById('resume-creator-status').textContent = '';
        document.getElementById('pdf-preview-area').style.display = 'none';
        const tab = new bootstrap.Tab(document.getElementById('resume-creator-tab'));
        tab.show();
    }
    
    function getHighlightedDescription(fullDescription) {
        if (!fullDescription) return 'No full description available.';
        return fullDescription.replace(/\n/g, '<br>');
    }

    function fetchJobs(status) {
        const tbody = document.getElementById('jobs-tbody');
        const spinner = document.getElementById('loading-spinner');
        const jobCountSpan = document.getElementById('job-count');

        spinner.style.display = 'block';
        tbody.innerHTML = '';
        jobCountSpan.textContent = '';

        fetch(`/get_jobs?status=${status}`)
            .then(res => res.json())
            .then(jobs => {
                spinner.style.display = 'none';
                jobCountSpan.textContent = `(${jobs.length})`;
                const totalTableColumns = 7;

                if (!jobs || jobs.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="${totalTableColumns}" class="text-center">No jobs in this category.</td></tr>`;
                    return;
                }

                jobs.forEach((job, index) => {
                    const mainRow = document.createElement('tr');
                    mainRow.style.cursor = 'pointer';

                    const descriptionRow = document.createElement('tr');
                    descriptionRow.id = `job-description-row-${job.id}`;
                    descriptionRow.style.display = 'none';

                    mainRow.onclick = function(event) {
                        if (event.target.closest('.actions')) return;
                        descriptionRow.style.display = descriptionRow.style.display === 'table-row' ? 'none' : 'table-row';
                    };

                    const sanitizedJobDescription = (job.job_description || '').replace(/'/g, "\\'").replace(/\n/g, '\\n').replace(/"/g, '&quot;');
                    const sanitizedJobTitle = (job.title || 'No Title').replace(/'/g, "\\'");
                    
                    let actionButtons = `<button class="btn btn-sm btn-outline-primary" onclick="event.stopPropagation(); openResumeCreatorTab(${job.id}, '${sanitizedJobTitle}', '${sanitizedJobDescription}')">Generate</button>`;

                    if (status === 'inbox') {
                        actionButtons += `<button class="btn btn-sm btn-secondary ms-1" onclick="event.stopPropagation(); updateJobStatus(${job.id}, 'want_to_apply')">Bookmark</button>`;
                    } else if (status === 'want_to_apply') {
                        actionButtons += `<button class="btn btn-sm btn-success ms-1" onclick="event.stopPropagation(); updateJobStatus(${job.id}, 'applied')">Mark Applied</button>`;
                    } else if (status === 'applied') {
                        actionButtons = `
                            <select class="form-select form-select-sm" onclick="event.stopPropagation();" onchange="updateJobStatus(${job.id}, this.value)">
                                <option value="applied" ${job.status === 'applied' ? 'selected' : ''}>Applied</option>
                                <option value="interviewing" ${job.status === 'interviewing' ? 'selected' : ''}>Interviewing</option>
                                <option value="offer" ${job.status === 'offer' ? 'selected' : ''}>Offer</option>
                                <option value="rejected" ${job.status === 'rejected' ? 'selected' : ''}>Rejected</option>
                                <option value="archived" ${job.status === 'archived' ? 'selected' : ''}>Archive</option>
                            </select>` + actionButtons;
                    }

                    const sourceBadge = job.source === 'LinkedIn' ? '<span class="badge bg-primary">LI</span>' : '<span class="badge bg-info">IN</span>';
                    let displayDate = 'N/A';
                    if (job.date && !isNaN(new Date(job.date))) {
                        displayDate = new Date(job.date).toLocaleDateString();
                    }
                    
                    function getExperienceSnippet(jobDescription) {
                        if (!jobDescription) return 'N/A';
                        const keywords = ['experience', 'years of', 'bachelor', 'degree', 'master', 'phd'];
                        const lowerDesc = jobDescription.toLowerCase();
                        for (const keyword of keywords) {
                            const index = lowerDesc.indexOf(keyword);
                            if (index !== -1) {
                                let start = Math.max(0, index - 15);
                                let end = Math.min(jobDescription.length, index + keyword.length + 50);
                                return '...' + jobDescription.substring(start, end) + '...';
                            }
                        }
                        return jobDescription.substring(0, 70) + '...';
                    }
                    const jdExperienceSnippet = getExperienceSnippet(job.job_description);

                    mainRow.innerHTML = `
                        <td>${index + 1}</td>
                        <td>${sourceBadge}</td>
                        <td>${displayDate}</td>
                        <td>
                            <a href="${job.job_url || '#'}" target="_blank" class="fw-bold" onclick="event.stopPropagation()">${job.title || 'No Title'}</a>
                            <div class="text-muted">${job.company || 'No Company'}</div>
                        </td>
                        <td><div class="jd-experience-snippet small">${jdExperienceSnippet}</div></td>
                        <td>${job.location || 'No Location'}</td>
                        <td class="actions">${actionButtons}</td>
                    `;
                    tbody.appendChild(mainRow);

                    descriptionRow.innerHTML = `
                        <td colspan="${totalTableColumns}">
                            <div class="p-3 bg-light border rounded">
                                <h5>Full Job Description:</h5>
                                <pre style="white-space: pre-wrap; font-family: inherit; font-size: 0.9rem;">${getHighlightedDescription(job.job_description)}</pre>
                            </div>
                        </td>
                    `;
                    tbody.appendChild(descriptionRow);
                });
            })
            .catch(err => {
                spinner.style.display = 'none';
                console.error('Error fetching jobs:', err);
                tbody.innerHTML = `<tr><td colspan="7" class="text-center">Error fetching jobs.</td></tr>`;
            });
    }

    function updateJobStatus(jobId, newStatus) {
        fetch(`/update_job_status/${jobId}`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ status: newStatus })
        })
        .then(() => {
            fetchJobs(currentJobStatus);
        })
        .catch(err => console.error('Error updating job status:', err));
    }

    function startScrape() {
        const payload = {
            source: document.getElementById('source-select').value,
            days: parseInt(document.getElementById('time-value').value, 10),
            management_option: document.querySelector('input[name="scrape-mode"]:checked').value,
            location: document.getElementById('scrape-location').value,
            keywords: document.getElementById('scrape-keywords').value
        };

        document.getElementById('scrape-button').disabled = true;
        document.getElementById('scrape-status').textContent = 'Status: Starting...';
        statusInterval = setInterval(checkScrapeStatus, 2000);

        fetch('/scrape', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        }).catch(err => {
            document.getElementById('scrape-status').textContent = `Error: ${err.message}`;
            document.getElementById('scrape-button').disabled = false;
            clearInterval(statusInterval);
        });
    }

    function checkScrapeStatus() {
        fetch('/scrape_status')
            .then(res => res.json())
            .then(status => {
                document.getElementById('scrape-status').textContent = `Status: ${status.message}`;
                if (!status.is_running) {
                    clearInterval(statusInterval);
                    document.getElementById('scrape-button').disabled = false;
                    if (status.message.includes('complete')) {
                        document.querySelector('#main-tabs .nav-link.active').click();
                    }
                }
            });
    }

    document.addEventListener('DOMContentLoaded', function() {
        updateTimeUnitOptions();

        document.querySelectorAll('#main-tabs .nav-link[data-bs-toggle="tab"]').forEach(tab => {
            if (tab.dataset.status) {
                tab.addEventListener('shown.bs.tab', event => {
                    currentJobStatus = event.target.dataset.status;
                    fetchJobs(currentJobStatus);
                });
            }
        });
        
        fetchJobs(currentJobStatus);

        document.getElementById('generate-resume-cv-button').addEventListener('click', function() {
            const jobDesc = document.getElementById('job-description-input').value;
            const statusElement = document.getElementById('resume-creator-status');
            const generateButton = this;
            const pdfPreviewArea = document.getElementById('pdf-preview-area');
            const jobId = document.getElementById('resume-job-id').value;

            if (!jobDesc.trim()) {
                statusElement.textContent = 'Job description is required.';
                statusElement.className = 'alert alert-warning mt-3';
                return;
            }

            statusElement.textContent = 'Generating documents... This may take up to 30 seconds.';
            statusElement.className = 'alert alert-info mt-3';
            generateButton.disabled = true;
            pdfPreviewArea.style.display = 'none';

            fetch('/generate_documents', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ job_description: jobDesc, job_id: jobId ? parseInt(jobId, 10) : null }),
            })
            .then(response => response.json().then(data => ({ ok: response.ok, data })))
            .then(({ ok, data }) => {
                if (ok && data.success) {
                    document.getElementById('resume-preview-iframe').src = data.resume_pdf_url;
                    document.getElementById('cv-preview-iframe').src = data.cover_letter_pdf_url;
                    pdfPreviewArea.style.display = 'block';
                    statusElement.textContent = 'Documents generated successfully!';
                    statusElement.className = 'alert alert-success mt-3';
                } else {
                    throw new Error(data.details || data.error || 'An unknown error occurred.');
                }
            })
            .catch(error => {
                statusElement.textContent = `Request failed: ${error.message}`;
                statusElement.className = 'alert alert-danger mt-3';
            })
            .finally(() => {
                generateButton.disabled = false;
            });
        });
    });
</script>
{% endblock %}